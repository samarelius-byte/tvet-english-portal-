<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced English Mastery Chatbot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a0ca3;
            --secondary: #7209b7;
            --accent: #4cc9f0;
            --light: #f8f9fa;
            --dark: #212529;
            --success: #4ade80;
            --warning: #fbbf24;
            --error: #ef4444;
            --user-msg: #4361ee;
            --bot-msg: #f1f5f9;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            height: 90vh;
        }

        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        select, button {
            padding: 10px 15px;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
        }

        select {
            background: white;
            color: var(--dark);
            min-width: 100px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: #3aa5d0;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f9fafb;
        }

        .message {
            max-width: 80%;
            padding: 15px;
            border-radius: 18px;
            line-height: 1.5;
            animation: fadeIn 0.3s ease;
            position: relative;
        }

        .user-message {
            align-self: flex-end;
            background: var(--user-msg);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .bot-message {
            align-self: flex-start;
            background: var(--bot-msg);
            color: var(--dark);
            border-bottom-left-radius: 5px;
            box-shadow: 0 4px 6px var(--shadow);
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .bot-icon {
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 8px;
            font-size: 12px;
        }

        .user-icon {
            width: 24px;
            height: 24px;
            background: white;
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-left: 8px;
            font-size: 12px;
        }

        .bot-message h3 {
            color: var(--primary-dark);
            margin: 10px 0 5px 0;
            font-size: 1.1rem;
        }

        .bot-message strong {
            color: var(--primary-dark);
        }

        .bot-message em {
            color: var(--secondary);
            font-style: italic;
        }

        .bot-message ul, .bot-message ol {
            margin: 10px 0;
            padding-left: 20px;
        }

        .bot-message li {
            margin: 5px 0;
        }

        .bot-message code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        #input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #eaeaea;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        #user-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #ddd;
            border-radius: 50px;
            outline: none;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        #user-input:focus {
            border-color: var(--primary);
        }

        #send-button {
            background: var(--primary);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
        }

        #send-button:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .thinking {
            color: #6c757d;
            font-style: italic;
            align-self: flex-start;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .thinking-dots {
            display: flex;
            gap: 4px;
        }

        .thinking-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
            animation: bounce 1.5s infinite ease-in-out;
        }

        .thinking-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .thinking-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @media (max-width: 768px) {
            .container {
                height: 95vh;
                border-radius: 15px;
            }
            
            .message {
                max-width: 90%;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            select, .btn-secondary {
                width: 100%;
            }
        }

        .welcome-message {
            background: linear-gradient(135deg, #e0f7fa, #bbdefb);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary);
        }

        .welcome-message h2 {
            color: var(--primary-dark);
            margin-bottom: 10px;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .feature {
            background: rgba(255, 255, 255, 0.7);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .feature i {
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-graduation-cap"></i> Advanced English Mastery</h1>
            <p class="subtitle">AI-powered tutoring for English learners with Bahasa Malaysia support</p>
            <div class="controls">
                <select id="cefr-selector">
                    <option value="A1">A1 Beginner</option>
                    <option value="A2">A2 Elementary</option>
                    <option value="B1">B1 Intermediate</option>
                    <option value="B2">B2 Upper Intermediate</option>
                    <option value="C1" selected>C1 Advanced</option>
                    <option value="C2">C2 Proficiency</option>
                </select>
                <button class="btn-secondary" id="language-toggle">
                    <i class="fas fa-language"></i> <span id="language-text">English</span>
                </button>
                <button class="btn-primary" id="help-button">
                    <i class="fas fa-question-circle"></i> Help
                </button>
            </div>
        </header>

        <main id="chat-container">
            <div class="welcome-message">
                <h2>Welcome to your English learning assistant!</h2>
                <p>I'm here to help you improve your English skills. Select your CEFR level and start practicing!</p>
                
                <div class="features">
                    <div class="feature">
                        <i class="fas fa-comment-alt"></i>
                        <h3>Conversation Practice</h3>
                    </div>
                    <div class="feature">
                        <i class="fas fa-book"></i>
                        <h3>Grammar Explanations</h3>
                    </div>
                    <div class="feature">
                        <i class="fas fa-language"></i>
                        <h3>Vocabulary Building</h3>
                    </div>
                    <div class="feature">
                        <i class="fas fa-exchange-alt"></i>
                        <h3>Translation Support</h3>
                    </div>
                </div>
                
                <p>Try asking me something like: "Explain the difference between present perfect and past simple"</p>
            </div>

            <div class="message bot-message">
                <div class="message-header">
                    <div class="bot-icon"><i class="fas fa-robot"></i></div>
                    <span>English Tutor</span>
                </div>
                Hello! I'm your AI English tutor. I can help you practice grammar, vocabulary, and conversation at your selected level. I also provide support in Bahasa Malaysia if needed. How can I assist you today?
            </div>
        </main>

        <div id="input-container">
            <input type="text" id="user-input" placeholder="Type your message here..." autocomplete="off">
            <button id="send-button">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script>
        // DOM Elements
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const languageToggle = document.getElementById('language-toggle');
        const languageText = document.getElementById('language-text');
        const cefrSelector = document.getElementById('cefr-selector');
        const helpButton = document.getElementById('help-button');

        // State
        let currentLanguage = 'EN';
        let currentCefrLevel = 'C1';
        const API_KEY = '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';

        // System Prompt defining the AI's role and capabilities
        const systemPrompt = `You are an expert, friendly English tutor specializing in teaching students at various CEFR levels. Your goal is to help them master grammar, vocabulary, and communication skills appropriate for their level.

        Key Instructions:
        1.  **Multimodal Support:** Communicate primarily in English. If the user asks a question in Bahasa Malaysia or switches to BM, you can provide translations, explanations, or answers in BM to aid their comprehension.
        2.  **CEFR Level Focus:** Tailor your responses to the user's selected CEFR level (${currentCefrLevel}). Adjust complexity accordingly.
        3.  **Pedagogical Approach:**
            - Be encouraging and supportive.
            - If a user makes an error, politely provide the correct version and a brief explanation.
            - Provide examples in context.
            - Create exercises appropriate for the user's level.
        4.  **Response Format:** Use clear formatting with paragraphs, examples, and explanations. Avoid markdown.`;

        // Initialize conversation with the system prompt
        let conversationHistory = [
            { role: "system", content: systemPrompt },
            { role: "assistant", content: "Hello! I'm your AI English tutor. I can help you practice grammar, vocabulary, and conversation at your selected level. I also provide support in Bahasa Malaysia if needed. How can I assist you today?" }
        ];

        // Function to add a message to the chat UI
        function addMessageToChat(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(role + '-message');
            
            if (role === 'bot') {
                const messageHeader = document.createElement('div');
                messageHeader.classList.add('message-header');
                messageHeader.innerHTML = `
                    <div class="bot-icon"><i class="fas fa-robot"></i></div>
                    <span>English Tutor</span>
                `;
                messageDiv.appendChild(messageHeader);
            }
            
            const messageContent = document.createElement('div');
            messageContent.textContent = content;
            messageDiv.appendChild(messageContent);
            
            chatContainer.appendChild(messageDiv);
            // Scroll to the bottom to show the new message
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Function to show a "Thinking..." indicator
        function showThinkingIndicator() {
            const thinkingDiv = document.createElement('div');
            thinkingDiv.classList.add('thinking');
            thinkingDiv.innerHTML = `
                <span>AI is thinking</span>
                <div class="thinking-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            `;
            chatContainer.appendChild(thinkingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return thinkingDiv;
        }

        // Function to remove the "Thinking..." indicator
        function removeThinkingIndicator(indicator) {
            if (indicator && indicator.parentNode) {
                indicator.parentNode.removeChild(indicator);
            }
        }

        // Function to send the user message to the API
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // Disable UI while processing
            userInput.value = '';
            sendButton.disabled = true;

            // Add user's message to the UI and history
            addMessageToChat('user', message);
            conversationHistory.push({ role: "user", content: `[Language: ${currentLanguage}, CEFR: ${currentCefrLevel}] ${message}` });

            // Show thinking indicator
            const thinkingIndicator = showThinkingIndicator();

            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'English Tutor Chatbot'
                    },
                    body: JSON.stringify({
                        model: "deepseek/deepseek-chat-v3.1:free",
                        messages: conversationHistory,
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                if (data.choices && data.choices.length > 0) {
                    const aiResponse = data.choices[0].message.content;
                    // Add AI's response to the UI and history
                    addMessageToChat('bot', aiResponse);
                    conversationHistory.push({ role: "assistant", content: aiResponse });
                } else {
                    throw new Error('Unexpected API response structure.');
                }

            } catch (error) {
                console.error('Error:', error);
                addMessageToChat('bot', `Sorry, I encountered an error. Please try again. ${error.message}`);
            } finally {
                // Re-enable UI
                removeThinkingIndicator(thinkingIndicator);
                sendButton.disabled = false;
                userInput.focus();
            }
        }

        // Toggle Language Function
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'EN' ? 'BM' : 'EN';
            languageText.textContent = currentLanguage === 'EN' ? 'English' : 'Bahasa Malaysia';
            userInput.placeholder = currentLanguage === 'EN' 
                ? "Type your message or question here..." 
                : "Taip mesej atau soalan anda di sini...";
            
            // Add a message to the chat about the language switch
            addMessageToChat('bot', `Language switched to ${currentLanguage === 'EN' ? 'English' : 'Bahasa Malaysia'}.`);
            conversationHistory.push({ 
                role: "assistant", 
                content: `Language switched to ${currentLanguage === 'EN' ? 'English' : 'Bahasa Malaysia'}.` 
            });
        }

        // Update CEFR Level
        function updateCefrLevel() {
            currentCefrLevel = cefrSelector.value;
            
            // Add a message to the chat about the level change
            addMessageToChat('bot', `CEFR level changed to ${currentCefrLevel}. I will now tailor my responses to this level.`);
            conversationHistory.push({ 
                role: "assistant", 
                content: `CEFR level changed to ${currentCefrLevel}. I will now tailor my responses to this level.` 
            });
        }

        // Show help information
        function showHelp() {
            addMessageToChat('bot', `Here's how to use this tutor:\n
1. Select your CEFR level (A1-C2) to get appropriate responses\n
2. Toggle between English and Bahasa Malaysia for language support\n
3. Ask questions about grammar, vocabulary, or practice conversations\n
4. Request translations or explanations in either language\n\n
Try asking: "What's the difference between present perfect and past simple?" or "Boleh anda terangkan perbezaan antara 'although' dan 'despite'?"`);
        }

        // Event Listeners
        sendButton.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        languageToggle.addEventListener('click', toggleLanguage);
        cefrSelector.addEventListener('change', updateCefrLevel);
        helpButton.addEventListener('click', showHelp);

        // Focus the input field on load
        userInput.focus();
    </script>
</body>
</html>